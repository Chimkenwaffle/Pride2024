#include <Arduino.h>
#include "subsystems/drivetrain/drivetrain.h"
#include "subsystems/gyro/gyro.h"
#include "subsystems/switches/switches.h"
#include "subsystems/ballsensor/ballsensor.h"
#include "subsystems/superstate/superstate.h"
#include "constants.hpp"
#include <Adafruit_MCP3008.h>
#include <PrideUtils.h>

using namespace PrideUtils;

Adafruit_MCP3008 adc4;
Adafruit_MCP3008 adc5;
Adafruit_MCP3008 adc6;

const double rotation_P = .4;
const double rotation_D = 0.1;

void setup() {
  
  Serial.begin(9600);
  delay(250);

  if (CrashReport) {
    Serial.print(CrashReport);
    Serial.println();
    Serial.flush();
  }

  SuperState::setup();
  
  bool success = Gyro::setup();
  Gyro::setOrigin();
  Drivetrain::setup();
  Switches::setup();
  BallSensor::setup();

  // setup failed! 
  if (!success) {
    SuperState::changeState(State::INIT_FAILED);
    while (1) {
      SuperState::update();
      Serial.println("[SETUP] Failed to initialize gyro");
      delay(1000);
    }
  }

  SuperState::changeState(State::CALIBRATING);
  SuperState::update(true);

  // Line  sensor ADC
  // TODO: Replace w/ line sensor subsystem l8r
  adc4.begin(27, 11, 12, BallSensorConstants::CS1);
  adc5.begin(27, 11, 12, BallSensorConstants::CS2);
  adc6.begin(27, 11, 12, BallSensorConstants::CS3);

  
  while (Switches::getSwitchOne() == false) {
    Serial.println("[SETUP] Calibrating...");
    // Serial.println("Switch 1" + String(Switches::getSwitchOne()) + "\n Switch 2" + String(Switches::getSwitchTwo()) + "\n Switch 3" + String(Switches::getSwitchThree()) + "\n Switch 4" + String(Switches::getSwitchFour()) + "\n Switch 5" + String(Switches::getSwitchFive()));
    delay(100);
  }
  Serial.println("[SETUP] Calibrated");
  delay(200);

  SuperState::changeState(State::READY);
}

void loop() {
  SuperState::update();

  BallSensor::read();
  // Drivetrain::rotate(0.25);
  // Drivetrain::print();
  
  delay(1000/10);
}

